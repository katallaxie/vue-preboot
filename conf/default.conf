server {
  listen 80 default_server;
  listen [::]:80 default_server;

  # SSL configuration
  #
  # listen 443 ssl default_server;
  # listen [::]:443 ssl default_server;
  #
  # Self signed certs generated by the ssl-cert package
  # Don't use them in a production server!
  #
  # include snippets/snakeoil.conf;

  # Disable sendfile as per https://docs.vagrantup.com/v2/synced-folders/virtualbox.html
	sendfile off;

  root /usr/src/app/public;

  # Add index.php to the list if you are using PHP
  # index index.html index.htm;

  server_name _;

  location @fluffy {
    proxy_pass http://unix:/tmp/fluffy.sock;
    proxy_redirect off;
    proxy_buffering on;
    proxy_cache_revalidate on;

    proxy_set_header Host $host;
    proxy_set_header Referer $http_referer;
    proxy_set_header X-Forwarded-For $remote_addr;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_cache fluffy;
    proxy_cache_valid 1m;
    proxy_cache_key $scheme$host$proxy_host$request_uri;
    proxy_cache_lock on;

    proxy_cache_use_stale error timeout http_500 http_502 http_503 http_504;

    proxy_connect_timeout       300;
    proxy_send_timeout          300;
    proxy_read_timeout          300;
    send_timeout                300;
  }

  location /static/ {
    rewrite ^/static(/.*)$ $1 last;
  }

  location / {
    try_files $uri @fluffy;
    # First attempt to serve request as file, then
    # as directory, then fall back to displaying a 404.
    # try_files $uri $uri/ =404;
  }
}
